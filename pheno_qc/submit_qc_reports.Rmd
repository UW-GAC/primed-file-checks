---
title: "Add QC reports to the phenotype_harmonized tables"
author: "Adrienne Stilp"
date: "`r lubridate::today()`"
editor_options: 
  chunk_output_type: console
---

```{r}
library(AnVIL)
library(tidyverse)
library(knitr)

submit <- TRUE
```

# Get list of workspaces

Get the list of workspaces from the primed_inventory workspace.

```{r}
x <- avtable(
  "phenotype_inventory",
  namespace="primed-cc",
  name="primed_inventory"
)
x
```

## Figure out which need qc reports

```{r}
x <- x %>%
  # In case qc_report is not a column yet.
  bind_rows(tibble(qc_report=character())) %>%
  filter(is.na(qc_report))
```

# Split up phenotype files by workspace

```{r}
x_list <- x %>%
  group_by(workspace_namespace, workspace_name) %>%
  group_split()
```


# Submit all jobs and write out submission file

## Pull workflow config

```{r}
  # Update workflow config.
  workflow <- "primed-adrienne/pheno_qc"
  avworkflow(workflow)
  config <- avworkflow_configuration_get()
  config  
```

## Prepare inputs and submit for each workspace

```{r, results="asis"}
submission_list <- list()
for (i in 1:length(x_list)) {
  rows <- x_list[[i]] %>%
  select(
    phenotype_harmonized_id=phenotype_inventory_id,
    table_names=domain,
    file_names=file_path,
    workspace_namespace,
    workspace_name
  )
  workspace_namespace = unique(rows$workspace_namespace)
  workspace_name = unique(rows$workspace_name)
  
  cat(glue::glue("\n\n### {workspace_namespace}/{workspace_name}\n\n"))
  
  rows %>% kable() %>% print()
  
  filename = glue::glue(
    "qc_report_data_file_{workspace_namespace}_{workspace_name}.tsv",
    workspace_namespace=unique(rows$workspace_namespace),
    workspace_name=unique(rows$workspace_name)
  )
  write_tsv(rows, file=filename)
  bucket_file <- file.path(avbucket(), filename)
  gsutil_cp(filename, bucket_file) 
    
  # Prepare inputs.
  attributes <- c(
    "data_file" = glue::glue("\"{bucket_file}\"")
  )
  # Prefix the inputs with the workflow name
  names(attributes) <- sprintf("%s.%s", basename(workflow), names(attributes))
  
  inputs <- avworkflow_configuration_inputs(config)
  # Set inputs in the configuration input object.
  inputs <- inputs %>%
    mutate(attribute = attributes[name]) %>%
    mutate(attribute = ifelse(is.na(attribute), "", attribute))
  inputs %>% kable() %>% print()
  
  # Set workflow configuration.
  new_config <- avworkflow_configuration_update(config, inputs)
  new_config
  
  # Set the new inputs.
  avworkflow_configuration_set(new_config, dry=FALSE)
  # Submit workflow and save submission id.
  if (submit) {
    # NULL is the entityName - we are operating on files in the workspace instead of on a data table.
    # Unfortunately this returns the config, not the submission id.
    # Make sure to set useCallCache to FALSE!
      avworkflow_run(new_config, NULL, useCallCache=FALSE, dry=FALSE)
  
    # Get the submission id. We have to call avworkflow_jobs() and pull the first.
    # This is *likely* to be the submissionId but not guaranteed.
    # See Issue on bioconductor AnVIL github: https://github.com/Bioconductor/AnVIL/issues/102
    submission_list[[i]] <- avworkflow_jobs() %>%
      slice(1) %>%
      bind_cols(
        tibble(
          qc_data_workspace_namespace=workspace_namespace,
          qc_data_workspace_name=workspace_name
        )
      ) %>%
      select(qc_data_workspace_namespace, qc_data_workspace_name, submissionId, everything())
    
  }
}
```

## Write out submission id file

```{r}
submissions <- bind_rows(submission_list)
write_tsv(submissions, "qc_report_submission.tsv")
```

```{r}
submissions %>% kable()
```